<html>

<head>

<!-- Mobile friendly styles that ensure proper rendering and touch zooming -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Load Google Maps -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWLMNHOpkHQnyBKZdjyzA_22R20VZ36_E"></script>

<!-- Load this page's CSS -->
<link type="text/css" rel="stylesheet" href="/static/css/main.css" />

<!-- Load this page's Javascript -->
<script typSe="text/javascript" src="/static/css/MainPage.js"></script>

<!-- Load Bootstrap -->
<link type="text/css" rel="stylesheet" href="/static/bootstrap/css/bootstrap.css" />

<!-- Load Font Awesome (required for Bootstrap social buttons) -->
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<!-- Load Bootstrap social buttons -->
<link type="text/css" rel="stylesheet" href="/static/bootstrap/css/bootstrap-social.css" />

<style>
#map_canvas {
	width: 100%;
	height: 100%;
	background-color: #CCC;
}
</style>

<title>Vancouver Markets</title>

<script>
//variables

var currentLocation = new google.maps.LatLng(49.287092, -123.117703);
var communityIcon = 'static/Images/CommunityMarket.png';
var farmerIcon = 'static/Images/FarmerMarket.png';
var currentIcon = 'static/Images/CurrentLocation.png';
var markets = [];
//Dummy coordinate (if GeoLocation is not supported)
var currentLocation = new google.maps.LatLng(49.287092, -123.117703);
//For Google Maps Directions
var vStrokeColor = "#0DFF00";
var vzIndex = 1;
var directionsService = new google.maps.DirectionsService();

//Precondition: Database has data (or result will be empy)
//Purpose: Pull market latlon/ marketType from database 
//		-Generate an array of array of markets where 
//		array = [ [lat, lon, marketType, marketName]
//			      [lat, lon, marketType, marketName]
//				   ...  ...      ...   ]   

function retrieveMarkets() {
"{% for market in markets %}"
	var oneMarket = [];
	oneMarket.push("{{ market.lat }}");            //lat
	oneMarket.push("{{ market.lon }}");             //lon
	oneMarket.push("{{ market.market_type }}");                //market_type
	oneMarket.push("{{ market.name }}");                       //market_name
	
	markets.push(oneMarket);
"{% endfor %}"
}

function calcRoute(map, markerPosition) {
	var request = {
		origin: currentLocation,
		destination: markerPosition,
		travelMode: google.maps.TravelMode.DRIVING
		}

   var directionsDisplay = new google.maps.DirectionsRenderer({polylineOptions:{suppressPolylines:true, 
   																geodesic:true,  strokeColor:vStrokeColor, 
   																strokeWeight: 4, strokeOpacity: 1, zIndex: vzIndex}});
   directionsDisplay.setMap(map);

   directionsService.route(request, function(response, status) {
     if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
     }
   });
}
//Precondition: marker is valid
//Purpose: add functionality to marker when clicked (i.e. zoom and centre)

function addClickEvent(map, marker, markerPosition) {
	google.maps.event.addListener(marker, 'click', function() {
		map.setCenter(marker.position);
		map.setZoom(13);
		
		calcRoute(map, markerPosition);
	});
}

function createMarkers(map) {
	for (var i = 0; i < markets.length; i++) {
		var lat  = markets[i][0];
		var long = markets[i][1];
		var latlong = new google.maps.LatLng(markets[i][0], markets[i][1]);
		var marker;
		if (markets[i][2] == "Farmers Market")
			marker = new google.maps.Marker( {
					position: latlong,
					map: map,
					title: markets[i][3],
					icon: farmerIcon
				});
		else {
			marker = new google.maps.Marker( {
					position: latlong,
					map: map,
					title: markets[i][3],
					icon: communityIcon
			});
		}	
		addClickEvent(map, marker, latlong);
	}
}

//Precondition: map, and icons are initialized
//Purpose:  generate all google map markers given an array 
//		   (of array) of market information          

function initializeMarkers(map) {
	//pull market information from database
	retrieveMarkets();
	//create Markers on the google maps
	createMarkers(map);
	//reset Market size to 0
	markets.length = 0;
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Error: The Geolocation service failed.';
  } else {
    var content = 'Error: Your browser doesn\'t support geolocation.';
  }

  var options = {
    map: map,
    position: new google.maps.LatLng(60, 105),
    content: content
  };
  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}

//Precondition: google map api is loaded
//Purpose:  generate a google map and call helpers
//		    to initialize the markers           

function initializeMap() {
	//create the map 		
	var mapCanvas = document.getElementById('map_canvas');
	var mapOptions = {
		zoom: 10,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	}
	var map = new google.maps.Map(mapCanvas, mapOptions);
	// Try HTML5 geolocation
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
    	function(position) {
    		//Success: pos gets currentLocation
      		currentLocation = new google.maps.LatLng(position.coords.latitude,
                                     				position.coords.longitude);
      		map.setCenter(currentLocation);
      		//create the geolocation marker
			new google.maps.Marker( {
				position: currentLocation,
				map: map,
				title: "Current Location",
				icon: currentIcon
			});    
    	}, 
    	function() {
    	//Error: handle with error message
      	handleNoGeolocation(true);
    	});
  } else {
  		// Browser doesn't support Geolocation:
   		handleNoGeolocation(false);
  }
  //create the market markers
  initializeMarkers(map);
} 
google.maps.event.addDomListener(window, 'load', initializeMap);
</script>

</head>

<body>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.js"></script>

<!-- Fixed top navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <!-- Button menu for small window -->
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Vancouver Markets</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#all">All</a></li>       
            <li><a href="#open">Open</a></li>
            <li><a href="#closed">Closed</a></li>
            <li><a href="#upcoming">Upcoming</a></li>      
            <li><a href="#favourite">Favourite</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a class="btn btn-block btn-social btn-google-plus navbar-btn">
            <i class="fa fa-google-plus"></i> Sign in with Google
            </a>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a href="https://www.facebook.com/sharer/sharer.php?u=vancouver-markets.appspot.com" target="_blank" class="btn btn-social-icon btn-facebook btn-default navbar-btn">
            <i class="fa fa-facebook"></i>
            </a>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a href="https://twitter.com/share" target="_blank" class="btn btn-social-icon btn-twitter btn-default navbar-btn">
            <i class="fa fa-twitter"></i>
            </a>
          </ul>
        </div><!-- .navbar-collapse -->
      </div>
    </div>

<script type=text/javascript> 
jQuery(document).ready(function() {
    jQuery('.navbar-collapse .nav > li > a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
 
        // Show/Hide Tabs
        jQuery('.list ' + currentAttrValue).show().siblings().hide();
 
        // Change/remove current tab to active
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
 
        e.preventDefault();
    });
});
</script> <!-- javascript for navigation bar and tabs -->

<!-- Market List -->
<div class="list">

	<div id="all" class="tab-active">
    <table class="table table-striped">
        <thead>
            <tr>
            	<th></th>
                <th>Name</th>
                <th>Open Date</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for market in markets %}
            	<td>
            	<a href="#" class="btn">
            	<i class="fa fa-star-o fa-lg"></i>
            	<i class="fa fa-star fa-lg"></i>
            	</a>
            	</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.name }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.address }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    
    <div id="open" class="tab-hide">
    <table class="table table-striped">
        <thead>
            <tr>
            	<th></th>
                <th>Name</th>
                <th>Open Date</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for market in markets_open %}
            	<td>
            	<a href="#" class="btn">
            	<i class="fa fa-star-o fa-lg"></i>
            	<i class="fa fa-star fa-lg"></i>
            	</a>
            	</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.name }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.address }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    
    <div id="closed" class="tab-hide">
    <table class="table table-striped">
        <thead>
            <tr>
            	<th></th>
                <th>Name</th>
                <th>Open Date</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for market in markets_closed %}
            	<td>
            	<a href="#" class="btn">
            	<i class="fa fa-star-o fa-lg"></i>
            	<i class="fa fa-star fa-lg"></i>
            	</a>
            	</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.name }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.address }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    
    <div id="upcoming" class="tab-hide">
    <table class="table table-striped">
        <thead>
            <tr>
            	<th></th>
                <th>Name</th>
                <th>Open Date</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for market in markets_upcoming %}
            	<td>
            	<a href="#" class="btn">
            	<i class="fa fa-star-o fa-lg"></i>
            	<i class="fa fa-star fa-lg"></i>
            	</a>
            	</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.name }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</td>
                <td><a href="/detail/{{ market.key.id }}">{{ market.address }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    
    <div id="favourite" class="tab-hide">
    <table class="table table-striped">
        <thead>
            <tr>
            	<th></th>
                <th>Name</th>
                <th>Open Date</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            	<td>
            	<a href="#" class="btn">
            	<i class="fa fa-star-o fa-lg"></i>
            	<i class="fa fa-star fa-lg"></i>
            	</a>
            	</td>
                <td>Some market</td>
                <td>Some date</td>
                <td>Some address</td>
            </tr>
        </tbody>
    </table>
    </div>

</div>

<div class="container">

	<div class="map">
		<div id="map_canvas"></div>
	</div>

	<div class="details">
	{% block content %}
	{% endblock %}
	
</div>

<!-- Bottom navbar -->
{% include 'mainpage/footer.html' %}

</body>

</html>
