<html>

<head>
<!-- Load this page's CSS -->
<link type="text/css" rel="stylesheet" href="/static/css/main.css" />

<!-- Load this page's Javascript -->
<script typSe="text/javascript" src="/static/css/MainPage.js"></script>

<!-- Load Bootstrap -->
<link type="text/css" rel="stylesheet" href="/static/bootstrap/css/bootstrap.css" />

<!-- Load Font Awesome (required for Bootstrap social buttons) -->
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<!-- Load Bootstrap social buttons -->
<link type="text/css" rel="stylesheet" href="/static/bootstrap/css/bootstrap-social.css" />

<!-- Load Google Maps -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWLMNHOpkHQnyBKZdjyzA_22R20VZ36_E">
</script>

<style>
#map_canvas {
	width: 100%;
	height: 100%;
	background-color: #CCC;
}
</style>

<title>Vancouver Markets</title>

<script>
//variables

var currentLocation = new google.maps.LatLng(49.287092, -123.117703);
var communityIcon = 'static/Images/CommunityMarket.png';
var farmerIcon = 'static/Images/FarmerMarket.png';
var currentIcon = 'static/Images/CurrentLocation.png';
var markets = [];

//Precondition: Database has data (or result will be empy)
//Purpose: Pull market latlon/ marketType from database 
//		-Generate an array of array of markets where 
//		array = [ [lat, lon, marketType, marketName]
//			      [lat, lon, marketType, marketName]
//				   ...  ...      ...   ]   

function retrieveMarkets() {
"{% for market in markets %}"
	var oneMarket = [];
	oneMarket.push("{{ market.lat }}");            //lat
	oneMarket.push("{{ market.lon }}");             //lon
	oneMarket.push("{{ market.market_type }}");                //market_type
	oneMarket.push("{{ market.name }}");                       //market_name
	markets.push(oneMarket);
"{% endfor %}"
}

//Precondition: marker is valid
//Purpose: add functionality to marker when clicked (i.e. zoom and centre)

function addClickEvent(map, marker, lat, long, infowindow) {
	google.maps.event.addListener(marker, 'click', function() {
		map.setCenter(marker.position);
		map.setZoom(12);
		
		var latString = lat.toString();
		var longString = long.toString();
		var link = "http://www.google.com/maps?q=" + latString + ",+" + longString;
		var contentString = 
      '<a href=' + link + '>'+
      'Directions</a> '
      
		infowindow.setContent(contentString);
		infowindow.setPosition(marker.position)
		infowindow.open(map);
	});
}

function createMarkers(map, infoWindow) {
	for (var i = 0; i < markets.length; i++) {
		var lat  = markets[i][0];
		var long = markets[i][1];
		var latlong = new google.maps.LatLng(markets[i][0], markets[i][1]);
		var marker;
		if (markets[i][2] == "Farmers Market")
			marker = new google.maps.Marker( {
					position: latlong,
					map: map,
					title: markets[i][3],
					icon: farmerIcon
				});
		else {
			marker = new google.maps.Marker( {
					position: latlong,
					map: map,
					title: markets[i][3],
					icon: communityIcon
			});
		}	
		addClickEvent(map, marker, lat, long, infoWindow);
	}
}

//Precondition: map, and icons are initialized
//Purpose:  generate all google map markers given an array 
//		   (of array) of market information          

function initializeMarkers(map) {
	var infowindow = new google.maps.InfoWindow();
	//pull market information from database
	retrieveMarkets();
	//create Markers on the google maps
	createMarkers(map, infowindow);
	//reset Market size to 0
	markets.length = 0;
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Error: The Geolocation service failed.';
  } else {
    var content = 'Error: Your browser doesn\'t support geolocation.';
  }

  var options = {
    map: map,
    position: new google.maps.LatLng(49.287092, -123.117703),
    content: content
  };
  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}

//Precondition: google map api is loaded
//Purpose:  generate a google map and call helpers
//		    to initialize the markers           

function initializeMap() {
	//create the map 		
	var mapCanvas = document.getElementById('map_canvas');
	var mapOptions = {
		zoom: 10,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	}
	var map = new google.maps.Map(mapCanvas, mapOptions);
	//pos gets dummy coordinate Downtown Vancouver
	var pos;
	// Try HTML5 geolocation
  	if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
    	function(position) {
    		//Success: pos gets currentLocation
      		pos = new google.maps.LatLng(position.coords.latitude,
                                     	position.coords.longitude);
            map.setCenter(pos);
  			//create the geolocation marker
			new google.maps.Marker( {
				position: pos,
				map: map,
				title: "Current Location",
				icon: currentIcon
			});       	                        
    	}, 
    	function() {
    		//Error: handle with error message
      		handleNoGeolocation(true);
    	});
  } else {
  		// Browser doesn't support Geolocation:
   		handleNoGeolocation(false);
  }
  //create the market markers
  initializeMarkers(map);
} 
google.maps.event.addDomListener(window, 'load', initializeMap);
</script>

</head>

<body>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.js"></script>

<!-- Fixed top navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <!-- Button menu for small window -->
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://vancouver-markets.appspot.com">Vancouver Markets</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#tab1">All</a></li>       
            <li><a href="#tab2">Open</a></li>
            <li><a href="#tab3">Closed</a></li>
            <li><a href="#tab4">Upcoming</a></li>      
            <li><a href="#tab5">Favourite</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a class="btn btn-block btn-social btn-google-plus navbar-btn"><i class="fa fa-google-plus"></i> Sign in with Google</a>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a href="https://www.facebook.com/sharer/sharer.php?u=vancouver-markets.appspot.com" target="_blank" class="btn btn-social-icon btn-facebook btn-default navbar-btn"><i class="fa fa-facebook"></i></a>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <a href="https://twitter.com/share" target="_blank" class="btn btn-social-icon btn-twitter btn-default navbar-btn"><i class="fa fa-twitter"></i></a>
          </ul>
        </div><!-- .navbar-collapse -->
      </div>
    </div>

<div class="title"><a href="/">Vancouver Markets</a></div>

<script type=text/javascript> 
jQuery(document).ready(function() {
    jQuery('.navbar-collapse .nav > li > a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
 
        // Show/Hide Tabs
        jQuery('.tabs ' + currentAttrValue).show().siblings().hide();
 
        // Change/remove current tab to active
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
 
        e.preventDefault();
    });
});
</script> <!-- javascript for navigation bar and tabs -->

<div class="list">
<div class="tabs">
		<div class="tab-content">
			<div id="tab1" class="tab active">
				<p>
				<table>
            		<tr>
            			<td class="td1">Name</td>
            			<td class="td2">Open Date</td>
            			<td class="td2">Address</td>
            		</tr>
            		{% for market in markets %}
            		<tr>
            			<td class="td3"><a href="/detail/{{ market.key.id }}">{{ market.name }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.address }}</a></td>
            		</tr>
            		{% endfor %}
            	</table>
				</p>
			</div>

			<div id="tab2" class="tab">
				<p>
				<table>
            		<tr>
           				<td class="td1">Name</td>
            			<td class="td2">Open Date</td>
            			<td class="td2">Address</td>
            		</tr>
            		{% for market in markets_open %}
            		<tr>
            			<td class="td3"><a href="/detail/{{ market.key.id }}">{{ market.name }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.address }}</a></td>
            		</tr>
            		{% endfor %}
            	</table>
				</p>
			</div>

			<div id="tab3" class="tab">
				<p>
				<table>
            		<tr>
           				<td class="td1">Name</td>
            			<td class="td2">Open Date</td>
            			<td class="td2">Address</td>
            		</tr>
            		{% for market in markets_closed %}
            		<tr>
            			<td class="td3"><a href="/detail/{{ market.key.id }}">{{ market.name }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.address }}</a></td>
            		</tr>
            		{% endfor %}
            	</table>
				</p>
			</div>

			<div id="tab4" class="tab">
				<p>
				<table>
            		<tr>
           				<td class="td1">Name</td>
            			<td class="td2">Open Date</td>
            			<td class="td2">Address</td>
            		</tr>
            		{% for market in markets_upcoming %}
            		<tr>
            			<td class="td3"><a href="/detail/{{ market.key.id }}">{{ market.name }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.open_month }}</a></td>
            			<td class="td4"><a href="/detail/{{ market.key.id }}">{{ market.address }}</a></td>
            		</tr>
            		{% endfor %}
            		</table>
				</p>

			</div>
			<div id="tab5" class="tab">
				<p>
				<table>
            		<tr>
           				<td class="td1">Name</td>
            			<td class="td2">Open Date</td>
            			<td class="td2">Address</td>
            		</tr>
            		<tr>
            			<td class="td3">G Mobile Produce Market</td>
            			<td class="td4">date</td>
            			<td class="td4">address</td>
            		</tr>
            		<tr>
            			<td class="td3">H Mobile Produce Market</td>
            			<td class="td4">date</td>
            			<td class="td4">address</td>
            		</tr>
            	</table>
				</p>
			</div>

	</div>
	</div>

</div>

<div class="container">
	<div class="map">
		<div id="map_canvas"></div>
	</div>

	<div class="details">
	{% block content %}
	{% endblock %}
		<div class="fbtwt">
			<div class="twt")>
				<a class="twitter-share-button" href="http://eatlocal.org/">
					Tweet </a>
			</div>
			<div class="fb">
				<div class="fb-like" data-href="http://eatlocal.org/"
					data-layout="button_count" data-action="like"
					data-show-faces="false" data-share="true"></div>
			</div>
		</div>
	</div>
</div>

<!-- Bottom navbar -->
    <div class="navbar navbar-default navbar-bottom" role="navigation">
      <div class="container-fluid">
      Our Team: King Sejong<br>
      | JOL | GYP | JOP | EJK | JHC |
      </div>
    </div>

</body>

</html>
